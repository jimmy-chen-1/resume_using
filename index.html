{% extends "base.html" %}

{% block content %}
<div class="sim-container">
    <!-- 左侧面板 -->
    <div class="dashboard-panel">
        <div class="sim-header">
            <h2><i class="fas fa-chart-line"></i> 商业模拟进度追踪</h2>
            <div class="status-indicator {% if running %}running{% else %}stopped{% endif %}">
                <i class="fas fa-{% if running %}play-circle{% else %}stop-circle{% endif %}"></i>
                {{ '运行中' if running else '已结束' }}
            </div>
        </div>

        <!-- 进度指示器 -->
        <div class="progress-card animated-card">
            <div class="progress-header">
                <h3><i class="fas fa-tasks"></i> 模拟进度</h3>
                <div class="time-info">
                    {% if start_time %}
                    <i class="fas fa-clock"></i>
                    <span>已运行: {{ (now - start_time|to_datetime).seconds//3600 }}h {{ (now - start_time|to_datetime).seconds//60%60 }}m</span>
                    {% endif %}
                </div>
            </div>
            <div class="progress-bar-container">
                <div class="progress-bar" style="width: {{ progress }}%">
                    <span class="progress-text">{{ progress }}%</span>
                </div>
            </div>
        </div>

        <!-- 动态网格布局 -->
        <div class="dynamic-grid">
            <div class="stat-card animated-card">
                <div class="stat-icon">
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">模拟天数</span>
                    <span class="stat-value">
                        {% if logs %}
                            {{ logs|last|extract_day if logs|last else 0 }}
                        {% else %}0{% endif %}/{{ config.SIMULATION_DAYS }}
                    </span>
                </div>
            </div>
            
            <div class="stat-card animated-card">
                <div class="stat-icon">
                    <i class="fas fa-coins"></i>
                </div>
                <div class="stat-content">
                    <span class="stat-label">当前利润</span>
                    <span class="stat-value">${{ simulation_status.result.total_profit|default(0)|round(2) }}</span>
                </div>
            </div>
        </div>

        <!-- 日志面板 -->
        <div class="log-card animated-card">
            <div class="log-header">
                <h3><i class="fas fa-clipboard-list"></i> 实时事件日志</h3>
                <span class="badge">最近5条</span>
            </div>
            <div class="log-content">
                {% if logs %}
                    {% for log in logs[-5:] %}
                    <div class="log-item">
                        <span class="log-time">{{ now.strftime('%H:%M:%S') }}</span>
                        <span class="log-message">{{ log }}</span>
                    </div>
                    {% endfor %}
                {% else %}
                    <div class="log-item empty">等待日志更新...</div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- 右侧可视化面板 -->
    <div class="visualization-panel">
        <div class="result-card animated-card">
            <h3><i class="fas fa-chart-area"></i> 趋势可视化</h3>
            <div class="chart-container" id="latestChart">
                {% if progress >= 100 and simulation_status.result.charts %}
                <img src="{{ url_for('static', filename='simulation_results/' + simulation_status.result.charts[-1]) }}" 
                     alt="最终结果图表"
                     class="live-chart">
                {% else %}
                <div class="chart-placeholder">
                    <i class="fas fa-chart-bar fa-pulse"></i>
                    <span class="loading-text">{{ '加载最终结果...' if progress >=100 else '模拟进行中...' }}</span>
                </div>
                {% endif %}
            </div>
            <div class="chart-footer">
                <i class="fas fa-sync-alt"></i>
                <span class="update-time">最后更新: {{ now.strftime('%Y-%m-%d %H:%M:%S') }}</span>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    const PROGRESS_UPDATE_INTERVAL = 2000;
    const progressBar = document.querySelector('.progress-bar');
    const logContent = document.querySelector('.log-content');
    const latestChart = document.getElementById('latestChart');
    let updateTimer = null;

    // 动态网格交互效果
    const dynamicGrid = document.querySelector('.dynamic-grid');
    if(dynamicGrid) {
        dynamicGrid.addEventListener('mouseover', (e) => {
            if (e.target.closest('.stat-card')) {
                dynamicGrid.style.gap = '1.5rem';
                dynamicGrid.style.transform = 'scale(1.005)';
            }
        });
        
        dynamicGrid.addEventListener('mouseout', () => {
            dynamicGrid.style.gap = '1.2rem';
            dynamicGrid.style.transform = 'scale(1)';
        });
    }

    // 图表加载函数
    const loadLatestChart = () => {
        fetch('/get_latest_chart')
            .then(response => {
                if (!response.ok) throw new Error('图表加载失败');
                return response.json();
            })
            .then(data => {
                if(data.path && latestChart) {
                    latestChart.innerHTML = `
                        <img src="${data.path}" 
                             alt="实时趋势图" 
                             class="live-chart"
                             onerror="this.onerror=null;this.src='/static/error-chart.png'">`;
                }
            })
            .catch(error => {
                console.error('图表加载错误:', error);
                if(latestChart) {
                    latestChart.innerHTML = `
                        <div class="chart-error">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>图表加载失败</p>
                        </div>`;
                }
            });
    };

    // 界面更新函数
    const updateInterface = (data) => {
        // 更新进度条
        if(progressBar) {
            progressBar.style.width = `${data.progress}%`;
            progressBar.querySelector('.progress-text').textContent = `${data.progress}%`;
        }

        // 更新日志
        if(logContent) {
            logContent.innerHTML = data.logs.slice(-5).map(log => `
                <div class="log-item">
                    <span class="log-time">${new Date().toLocaleTimeString()}</span>
                    <span class="log-message">${log}</span>
                </div>
            `).join('');
            logContent.scrollTop = logContent.scrollHeight;
        }

        // 自动加载最终图表
        if(data.progress >= 100) {
            loadLatestChart();
            clearInterval(updateTimer);
        }
    };

    // 获取进度数据
    const fetchProgressData = () => {
        fetch('/get_progress')
            .then(response => {
                if (!response.ok) throw new Error(`HTTP错误: ${response.status}`);
                return response.json();
            })
            .then(data => {
                updateInterface(data);
                if(data.running) {
                    updateTimer = setTimeout(fetchProgressData, PROGRESS_UPDATE_INTERVAL);
                }
            })
            .catch(error => {
                console.error('进度更新失败:', error);
                if(logContent) {
                    logContent.innerHTML += `
                        <div class="log-item error">
                            <i class="fas fa-exclamation-circle"></i>
                            连接错误: ${error.message}
                        </div>`;
                }
            });
    };

    // 初始化加载
    fetchProgressData();

    // 页面可见性处理
    document.addEventListener('visibilitychange', () => {
        if (document.visibilityState === 'visible') {
            fetchProgressData();
            if(progress >= 100) loadLatestChart();
        }
    });

    // 窗口调整时重置布局
    window.addEventListener('resize', () => {
        if(progress >= 100) loadLatestChart();
    });
});
</script>

<style>
/* ========== 全局样式 ========== */
.sim-container {
    display: grid;
    grid-template-columns: 1fr 1.5fr;
    gap: 2rem;
    padding: 2rem;
    max-width: 1400px;
    margin: 0 auto;
    background: rgba(255,255,255,0.02);
    border-radius: 16px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
}

/* 动态网格过渡效果 */
.dynamic-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
    gap: 1.2rem;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

/* 统计卡片悬停动画 */
.stat-card {
    transition: transform 0.3s ease, box-shadow 0.3s ease;
    transform-origin: center;
}

.stat-card:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
}

/* 进度条动态效果 */
.progress-bar {
    transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1),
                background 0.5s ease;
    will-change: width;
}

/* 图表加载动画 */
.fa-pulse {
    animation: chartLoading 2s ease-in-out infinite;
}

@keyframes chartLoading {
    0% { opacity: 0.6; transform: scale(0.95); }
    50% { opacity: 1; transform: scale(1.05); }
    100% { opacity: 0.6; transform: scale(0.95); }
}

/* 响应式设计 */
@media (max-width: 1200px) {
    .sim-container {
        grid-template-columns: 1fr;
        padding: 1.5rem;
    }
    
    .live-chart {
        height: 400px;
    }
    
    .dynamic-grid {
        grid-template-columns: 1fr;
    }
}

@media (max-width: 768px) {
    .sim-container {
        padding: 1rem;
    }
    
    .live-chart {
        height: 300px;
    }
    
    .stat-card {
        padding: 1rem;
    }
}
</style>
{% endblock %}